
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Introduction to the STLAB light engine &#8212; PyPlr v1.0 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Calibration with OceanOptics VIS spectrometer" href="ocean_optics_calibration.html" />
    <link rel="prev" title="Measuring the pupillary light reflex with a Pupil Core headset" href="pupil_core.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Introduction-to-the-STLAB-light-engine">
<h1><strong>Introduction to the STLAB light engine</strong><a class="headerlink" href="#Introduction-to-the-STLAB-light-engine" title="Permalink to this headline">¶</a></h1>
<p>This notebook introduces the Spectra Tune Lab (STLAB: Ledmotive Technologies, LLC) — a spectrally tuneable light engine with 10 LED colour channels, capable of generating a broad range of spectral compositions. The STLAB can be controlled programmatically with most languages using its <strong>RESTFUL_API</strong>, which takes commands via generic http requests. The API includes commands to set a specific spectrum, turn the light off, get readouts from the onboard spectrometer, etc. For this project I am
developing a python module which uses the <strong>requests</strong> library to wrap around useful functions of the RESTFUL_API. It will also include other routines for working with the device.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">stlab</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;poster&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1">#Image(&quot;/Users/jtm/Documents/cvd_pupillometry/img/STLAB.png&quot;, width=300)</span>
</pre></div>
</div>
</div>
<p>Now, having imported the <strong>stlab</strong> module, and providing the device is properly connected, we can set it up as follows. The required password is device-specific.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">d</span> <span class="o">=</span> <span class="n">stlab</span><span class="o">.</span><span class="n">SpectraTuneLab</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;83e47941d9e930f6&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
STLAB device setup complete...
</pre></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">stlab.STLAB(...)</span></code> returns an instance of the <code class="docutils literal notranslate"><span class="pre">STLAB()</span></code> class, which serves as a handle to control all available functionality. The class instance has an ‘info’ dict which contains some info that needs to be accessed by internal methods (i.e. ‘url’, ‘id’, and ‘cookiejar’), and some other generic information about the configuration of the device.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="s1">&#39;---&gt;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
url ---&gt; 192.168.7.2
id ---&gt; 1
cookiejar ---&gt; &lt;RequestsCookieJar[&lt;Cookie lighthub=s%3ADw4k4t6ihVHu0WbEKz8jd1U3_ISX494n.LLgGmlBaPYuZagHOHZy3RymGWAypg2xoBQ2Tzv2Ll3Y for 192.168.7.2/&gt;]&gt;
gateway ---&gt; 0
csma_base_time ---&gt; 60
default_spectrum ---&gt; [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100, 100]
temperature_sensors_count ---&gt; 4
power_limit ---&gt; 100
pwm ---&gt; [6, 2, 7, 7, 1, 9, 3, 6, 5, 8, 4, 0]
critical_temperature ---&gt; 55
groups ---&gt; [65535, 65535, 65535, 65535]
csma_random_time ---&gt; 60
serial ---&gt; MD02017000000400012
feedback_sensor ---&gt; 1
model ---&gt; VEGA10
warning_temperature ---&gt; 50
power_protection ---&gt; 100
channels ---&gt; 10
address ---&gt; 1
</pre></div></div>
</div>
<p>Let’s play with some of the commands. In the following example, we set each LED in turn to its maximum intensity setting and take a reading from the on-board spectrometer. Note that the intensity of each LED is set with a value between 0 - 4095 (12-bit resolution depth), corresponding to the minimum and maximum input.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">leds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="n">intensity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4095</span><span class="p">]</span>
<span class="n">spectra</span> <span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">leds</span><span class="o">=</span><span class="n">leds</span><span class="p">,</span> <span class="n">intensities</span><span class="o">=</span><span class="n">intensity</span><span class="p">,</span> <span class="n">wait_before_sample</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Sampling 10 leds at the following intensities: [4095]
Measurement: 1 / 10, LED: 0, intensity: 4095
Measurement: 2 / 10, LED: 1, intensity: 4095
Measurement: 3 / 10, LED: 2, intensity: 4095
Measurement: 4 / 10, LED: 3, intensity: 4095
Measurement: 5 / 10, LED: 4, intensity: 4095
Measurement: 6 / 10, LED: 5, intensity: 4095
Measurement: 7 / 10, LED: 6, intensity: 4095
Measurement: 8 / 10, LED: 7, intensity: 4095
Measurement: 9 / 10, LED: 8, intensity: 4095
Measurement: 10 / 10, LED: 9, intensity: 4095
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spectra</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span><span class="n">info</span><span class="p">[[</span><span class="s1">&#39;led&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">]])</span>
<span class="n">spectra</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">long</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">long</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">long</span> <span class="o">=</span> <span class="n">long</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">STLAB.sample(...)</span></code> method is just a convenient way of sampling a range of LEDs at some given intensity settings using the STLABs on-board spectrometer. It may also come in handy when we make measurements with an external spectrometer.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">pinfo2</span> stlab.STLAB.sample
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">Signature:</span>
stlab<span class="ansi-blue-fg">.</span>STLAB<span class="ansi-blue-fg">.</span>sample<span class="ansi-blue-fg">(</span>
    self<span class="ansi-blue-fg">,</span>
    leds<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
    intensities<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">500</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
    spectra<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    wait_before_sample<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.2</span><span class="ansi-blue-fg">,</span>
    ocean_optics<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    randomise<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    save_output<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>
Sample a set of LEDs individually at a range of specified intensities
using the STLABs on-board spectrometer. Or, alternatively, sample a set
of pre-defined spectra. Option to also obtain concurrent measurements
with an external Ocean Optics spectrometer.

Parameters
----------
leds : list, optional
    List of unique integers from 0-9 representing the LEDs to sample.
    The default is [0].
intensities : list, optional
    List of integer values between 0-4095 representing the intensity
    values at which to sample the LEDs. The default is [500].
spectra : list, optinal
    List of predfined spectra to sample. Must be None if specifying
    leds or intensities. The default is None.
wait_before_sample : float, optional
    Time in seconds to wait after setting a spectrum before acquiring
    a measurement from the spectrometer(s). The default is .2.
ocean_optics : seabreeze.spectrometers.Spectrometer, optional
    Whether to acquire concurrent measurements from an Ocean Optics
    spectrometer. Requires the seabreeze package to be installed.
    The default is None.
randomise : bool, optional
    Whether to randomise the order in which the LED-intensity settings
    or spectra are sampled. The default is False.
save_output : bool, optional
    Whether to save the samples and info as .csv files in the current
    working directory.

Returns
-------
stlab_spectra : pd.DataFrame
    The resulting measurements from the STLAB spectrometer.
stlab_info : pd.DataFrame
    The companion info to stlab_spectra, with matching indices.
oo_spectra : pd.DataFrame, optional
    The resulting measurements from the Ocean Optics spectrometer.
oo_info : pd.DataFrame, optional
    The companion info to the oo_spectra, with matching indices.

<span class="ansi-red-fg">Source:</span>
    <span class="ansi-green-fg">def</span> sample<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>
               leds<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
               intensities<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">500</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
               spectra<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
               wait_before_sample<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">.2</span><span class="ansi-blue-fg">,</span>
               ocean_optics<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
               randomise<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
               save_output<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">&#39;&#39;&#39;</span>
<span class="ansi-blue-fg">        Sample a set of LEDs individually at a range of specified intensities </span>
<span class="ansi-blue-fg">        using the STLABs on-board spectrometer. Or, alternatively, sample a set</span>
<span class="ansi-blue-fg">        of pre-defined spectra. Option to also obtain concurrent measurements </span>
<span class="ansi-blue-fg">        with an external Ocean Optics spectrometer.</span>
<span class="ansi-blue-fg">    </span>
<span class="ansi-blue-fg">        Parameters</span>
<span class="ansi-blue-fg">        ----------</span>
<span class="ansi-blue-fg">        leds : list, optional</span>
<span class="ansi-blue-fg">            List of unique integers from 0-9 representing the LEDs to sample.</span>
<span class="ansi-blue-fg">            The default is [0].</span>
<span class="ansi-blue-fg">        intensities : list, optional</span>
<span class="ansi-blue-fg">            List of integer values between 0-4095 representing the intensity </span>
<span class="ansi-blue-fg">            values at which to sample the LEDs. The default is [500].</span>
<span class="ansi-blue-fg">        spectra : list, optinal</span>
<span class="ansi-blue-fg">            List of predfined spectra to sample. Must be None if specifying</span>
<span class="ansi-blue-fg">            leds or intensities. The default is None.</span>
<span class="ansi-blue-fg">        wait_before_sample : float, optional</span>
<span class="ansi-blue-fg">            Time in seconds to wait after setting a spectrum before acquiring </span>
<span class="ansi-blue-fg">            a measurement from the spectrometer(s). The default is .2.</span>
<span class="ansi-blue-fg">        ocean_optics : seabreeze.spectrometers.Spectrometer, optional</span>
<span class="ansi-blue-fg">            Whether to acquire concurrent measurements from an Ocean Optics </span>
<span class="ansi-blue-fg">            spectrometer. Requires the seabreeze package to be installed.</span>
<span class="ansi-blue-fg">            The default is None.</span>
<span class="ansi-blue-fg">        randomise : bool, optional</span>
<span class="ansi-blue-fg">            Whether to randomise the order in which the LED-intensity settings </span>
<span class="ansi-blue-fg">            or spectra are sampled. The default is False.</span>
<span class="ansi-blue-fg">        save_output : bool, optional</span>
<span class="ansi-blue-fg">            Whether to save the samples and info as .csv files in the current</span>
<span class="ansi-blue-fg">            working directory.</span>
<span class="ansi-blue-fg">    </span>
<span class="ansi-blue-fg">        Returns</span>
<span class="ansi-blue-fg">        -------</span>
<span class="ansi-blue-fg">        stlab_spectra : pd.DataFrame</span>
<span class="ansi-blue-fg">            The resulting measurements from the STLAB spectrometer.</span>
<span class="ansi-blue-fg">        stlab_info : pd.DataFrame</span>
<span class="ansi-blue-fg">            The companion info to stlab_spectra, with matching indices.</span>
<span class="ansi-blue-fg">        oo_spectra : pd.DataFrame, optional</span>
<span class="ansi-blue-fg">            The resulting measurements from the Ocean Optics spectrometer.</span>
<span class="ansi-blue-fg">        oo_info : pd.DataFrame, optional</span>
<span class="ansi-blue-fg">            The companion info to the oo_spectra, with matching indices.</span>
<span class="ansi-blue-fg">            </span>
<span class="ansi-blue-fg">        &#39;&#39;&#39;</span>
        <span class="ansi-green-fg">if</span> spectra <span class="ansi-green-fg">and</span> <span class="ansi-blue-fg">(</span>leds <span class="ansi-green-fg">or</span> intensities<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">raise</span> ValueError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;leds and intensities must be None when specifying spectra&#39;</span><span class="ansi-blue-fg">)</span>

        <span class="ansi-red-fg"># off spectrum    </span>
        leds_off <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span><span class="ansi-cyan-fg">10</span>

        <span class="ansi-red-fg"># list to store stlab spectrometer data</span>
        stlab_spectra <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>
        stlab_info  <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>

        <span class="ansi-red-fg"># list to store ocean optics spectrometer data, if required</span>
        <span class="ansi-green-fg">if</span> ocean_optics<span class="ansi-blue-fg">:</span>
            oo_spectra <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>
            oo_info  <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>

        <span class="ansi-red-fg"># turn stlab off if it&#39;s on</span>
        self<span class="ansi-blue-fg">.</span>set_spectrum_a<span class="ansi-blue-fg">(</span>leds_off<span class="ansi-blue-fg">)</span>

        <span class="ansi-red-fg"># generate the settings</span>
        <span class="ansi-green-fg">if</span> spectra<span class="ansi-blue-fg">:</span>
            settings <span class="ansi-blue-fg">=</span> spectra
            print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Sampling {} spectra: {}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>
                len<span class="ansi-blue-fg">(</span>spectra<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> spectra<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
            settings <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">(</span>l<span class="ansi-blue-fg">,</span> i<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">for</span> l <span class="ansi-green-fg">in</span> leds <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> intensities<span class="ansi-blue-fg">]</span>
            print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Sampling {} leds at the following intensities: {}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>
                len<span class="ansi-blue-fg">(</span>leds<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> intensities<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

        <span class="ansi-red-fg"># shuffle</span>
        <span class="ansi-green-fg">if</span> randomise<span class="ansi-blue-fg">:</span>
            shuffle<span class="ansi-blue-fg">(</span>settings<span class="ansi-blue-fg">)</span>

        <span class="ansi-red-fg"># begin sampling            </span>
        <span class="ansi-green-fg">for</span> i<span class="ansi-blue-fg">,</span> s <span class="ansi-green-fg">in</span> enumerate<span class="ansi-blue-fg">(</span>settings<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> spectra<span class="ansi-blue-fg">:</span>
                led<span class="ansi-blue-fg">,</span> intensity <span class="ansi-blue-fg">=</span> s<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> s<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span>
                setting <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">{</span><span class="ansi-blue-fg">&#39;led&#39;</span> <span class="ansi-blue-fg">:</span> led<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;intensity&#39;</span> <span class="ansi-blue-fg">:</span> intensity<span class="ansi-blue-fg">}</span>
                s <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span><span class="ansi-cyan-fg">10</span>
                s<span class="ansi-blue-fg">[</span>led<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> intensity
                print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Measurement: {} / {}, LED: {}, intensity: {}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>
                    i<span class="ansi-blue-fg">+</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> len<span class="ansi-blue-fg">(</span>settings<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> led<span class="ansi-blue-fg">,</span> intensity<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
                setting <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">{</span><span class="ansi-blue-fg">&#39;intensities&#39;</span> <span class="ansi-blue-fg">:</span> s<span class="ansi-blue-fg">}</span>
                print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Measurement: {} / {}, spectrum: {}&#39;</span><span class="ansi-blue-fg">.</span>format<span class="ansi-blue-fg">(</span>
                    i<span class="ansi-blue-fg">+</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> len<span class="ansi-blue-fg">(</span>settings<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> s<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

            <span class="ansi-red-fg"># set the spectrum</span>
            self<span class="ansi-blue-fg">.</span>set_spectrum_a<span class="ansi-blue-fg">(</span>s<span class="ansi-blue-fg">)</span>
            sleep<span class="ansi-blue-fg">(</span>wait_before_sample<span class="ansi-blue-fg">)</span>

            <span class="ansi-red-fg"># full readout from STLAB</span>
            stlab_counts<span class="ansi-blue-fg">,</span> stlab_info_dict <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>full_readout<span class="ansi-blue-fg">(</span>setting<span class="ansi-blue-fg">=</span>setting<span class="ansi-blue-fg">)</span>
            stlab_spectra<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>stlab_counts<span class="ansi-blue-fg">)</span>
            stlab_info<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>stlab_info_dict<span class="ansi-blue-fg">)</span>

            <span class="ansi-green-fg">if</span> ocean_optics<span class="ansi-blue-fg">:</span>
                oo_counts<span class="ansi-blue-fg">,</span> oo_info_dict <span class="ansi-blue-fg">=</span> adaptive_measurement<span class="ansi-blue-fg">(</span>
                    ocean_optics<span class="ansi-blue-fg">,</span> setting<span class="ansi-blue-fg">=</span>setting<span class="ansi-blue-fg">)</span>
                oo_spectra<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>oo_counts<span class="ansi-blue-fg">)</span>
                oo_info<span class="ansi-blue-fg">.</span>append<span class="ansi-blue-fg">(</span>oo_info_dict<span class="ansi-blue-fg">)</span>

        <span class="ansi-red-fg"># make dfs</span>
        stlab_spectra <span class="ansi-blue-fg">=</span> pd<span class="ansi-blue-fg">.</span>DataFrame<span class="ansi-blue-fg">(</span>stlab_spectra<span class="ansi-blue-fg">)</span>
        stlab_spectra<span class="ansi-blue-fg">.</span>columns <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>wlbins
        stlab_info <span class="ansi-blue-fg">=</span> pd<span class="ansi-blue-fg">.</span>DataFrame<span class="ansi-blue-fg">(</span>stlab_info<span class="ansi-blue-fg">)</span>

        <span class="ansi-green-fg">if</span> ocean_optics<span class="ansi-blue-fg">:</span>
            oo_spectra <span class="ansi-blue-fg">=</span> pd<span class="ansi-blue-fg">.</span>DataFrame<span class="ansi-blue-fg">(</span>oo_spectra<span class="ansi-blue-fg">)</span>
            oo_spectra<span class="ansi-blue-fg">.</span>columns <span class="ansi-blue-fg">=</span> ocean_optics<span class="ansi-blue-fg">.</span>wavelengths<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
            oo_info <span class="ansi-blue-fg">=</span> pd<span class="ansi-blue-fg">.</span>DataFrame<span class="ansi-blue-fg">(</span>oo_info<span class="ansi-blue-fg">)</span>

        <span class="ansi-red-fg"># turn off</span>
        self<span class="ansi-blue-fg">.</span>turn_off<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

        <span class="ansi-green-fg">if</span> save_output<span class="ansi-blue-fg">:</span>
            fid <span class="ansi-blue-fg">=</span> datetime<span class="ansi-blue-fg">.</span>now<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>strftime<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;%D-%H-%M&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>replace<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;/&#39;</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">&#39;-&#39;</span><span class="ansi-blue-fg">)</span>
            stlab_spectra<span class="ansi-blue-fg">.</span>to_csv<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;stlab_spectra_&#39;</span> <span class="ansi-blue-fg">+</span> fid <span class="ansi-blue-fg">+</span> <span class="ansi-blue-fg">&#39;.csv&#39;</span><span class="ansi-blue-fg">)</span>
            stlab_info<span class="ansi-blue-fg">.</span>to_csv<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;stlab_info_&#39;</span> <span class="ansi-blue-fg">+</span> fid <span class="ansi-blue-fg">+</span> <span class="ansi-blue-fg">&#39;.csv&#39;</span><span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">if</span> ocean_optics<span class="ansi-blue-fg">:</span>
                oo_spectra<span class="ansi-blue-fg">.</span>to_csv<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;oo_spectra_&#39;</span> <span class="ansi-blue-fg">+</span> fid <span class="ansi-blue-fg">+</span> <span class="ansi-blue-fg">&#39;.csv&#39;</span><span class="ansi-blue-fg">)</span>
                oo_info<span class="ansi-blue-fg">.</span>to_csv<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;oo_info_&#39;</span> <span class="ansi-blue-fg">+</span> fid <span class="ansi-blue-fg">+</span> <span class="ansi-blue-fg">&#39;.csv&#39;</span><span class="ansi-blue-fg">)</span>

        <span class="ansi-green-fg">if</span> ocean_optics<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">return</span> stlab_spectra<span class="ansi-blue-fg">,</span> stlab_info<span class="ansi-blue-fg">,</span> oo_spectra<span class="ansi-blue-fg">,</span> oo_info
        <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">return</span> stlab_spectra<span class="ansi-blue-fg">,</span> stlab_info
<span class="ansi-red-fg">File:</span>      ~/Code/cvd_pupillometry/PyPlr/pyplr/stlab.py
<span class="ansi-red-fg">Type:</span>      function

</pre></div></div>
</div>
<p>Now, using the data that we just collected, we can plot the spectral power distributions of the 10 channels at maximum and their CIE 1931 <em>xy</em> chromaticity coordinates, which define the gamut of the device. Note that the <em>xy</em> chromaticity coordinates can be quickly calculated by passing the output of <code class="docutils literal notranslate"><span class="pre">Device.sample_leds(...)</span></code> (or DataFrame with the same format) to <code class="docutils literal notranslate"><span class="pre">stlab.spectra_to_xyz(...)</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">colour.plotting</span> <span class="kn">import</span> <span class="n">plot_chromaticity_diagram_CIE1931</span>

<span class="c1"># calculate xy chromaticity coordinates</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">stlab</span><span class="o">.</span><span class="n">spectra_to_xyz</span><span class="p">(</span><span class="n">long</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># set up figure</span>
<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="c1"># plot SPDs</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">long</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;led&quot;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">rgb_colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux (mW)&quot;</span><span class="p">)</span>


<span class="c1"># plotting the *CIE xy* chromaticity coordinates.</span>
<span class="n">plot_chromaticity_diagram_CIE1931</span><span class="p">(</span><span class="n">standalone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_spectral_locus</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-.</span><span class="mi">15</span><span class="p">,</span><span class="o">.</span><span class="mi">9</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-.</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">texts</span><span class="p">:</span>
    <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;/Users/jtm/Documents/cvd_pupillometry/data/stlab/spds_poster_gamut.svg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/stlab_and_sphere_12_0.png" src="_images/stlab_and_sphere_12_0.png" />
</div>
</div>
<p>For a more nuanced understanding of the device’s output we would need to sample at a range of intensities, such as from minimum to maximum in steps of 63:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">leds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="n">intensities</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4096</span><span class="p">,</span><span class="mi">65</span><span class="p">)]</span>
<span class="n">spectra</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">sample_leds</span><span class="p">(</span><span class="n">leds</span><span class="o">=</span><span class="n">leds</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="n">intensities</span><span class="p">,</span> <span class="n">wait_before_sample</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>But this will take about five minutes to run, so let’s just load the results from csv.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># load existing data</span>
<span class="n">spectra</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;/Users/jtm/Documents/cvd_pupillometry/data/stlab/10led_65intensity.csv&quot;</span><span class="p">)</span>

<span class="c1"># set up figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># plot SPDs</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">spectra</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;led&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">estimator</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux (mW)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;/Users/jtm/Documents/cvd_pupillometry/data/stlab/spds_10_leds_65_spec.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/stlab_and_sphere_14_0.png" src="_images/stlab_and_sphere_14_0.png" />
</div>
</div>
<p>Looks like what we might reasonably expect, but it would be useful to see how the spectral power distributions for each LED vary in terms of <em>xy</em> chromaticity, as well as peak / dominant wavelength and melanopic irradiance as a function of input. I have created a convenient function for this.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spectra</span><span class="o">.</span><span class="n">intensity</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">stlab</span><span class="o">.</span><span class="n">explore_spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/stlab_and_sphere_16_0.png" src="_images/stlab_and_sphere_16_0.png" />
</div>
</div>
<div class="section" id="Forward-model">
<h2><strong>Forward model</strong><a class="headerlink" href="#Forward-model" title="Permalink to this headline">¶</a></h2>
<p>Using linear interpolation on these spectra we can create a lookup table to predict the spectral power distribution for each primary at all intensity levels between 0 and 4095. This can be thought of as a forward model of the device.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spectra</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../../../data/stlab/10led_65intensity.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span><span class="s1">&#39;wavelength&#39;</span><span class="p">])</span>
<span class="n">lkp_tbl</span> <span class="o">=</span> <span class="n">stlab</span><span class="o">.</span><span class="n">interp_spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>
<span class="n">lkp_tbl</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">wlbins</span>
<span class="n">lkp_tbl</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>380.0</th>
      <th>385.0</th>
      <th>390.0</th>
      <th>395.0</th>
      <th>400.0</th>
      <th>405.0</th>
      <th>410.0</th>
      <th>415.0</th>
      <th>420.0</th>
      <th>425.0</th>
      <th>...</th>
      <th>735.0</th>
      <th>740.0</th>
      <th>745.0</th>
      <th>750.0</th>
      <th>755.0</th>
      <th>760.0</th>
      <th>765.0</th>
      <th>770.0</th>
      <th>775.0</th>
      <th>780.0</th>
    </tr>
    <tr>
      <th>led</th>
      <th>intensity</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.229296</td>
      <td>0.398322</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.458592</td>
      <td>0.796645</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.687888</td>
      <td>1.194967</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.917184</td>
      <td>1.593289</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">9</th>
      <th>4091</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.707791</td>
      <td>0.049435</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4092</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.719787</td>
      <td>0.037076</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4093</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.731783</td>
      <td>0.024718</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4094</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.743780</td>
      <td>0.012359</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4095</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.755776</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>40960 rows × 81 columns</p>
</div></div>
</div>
<p>Now we just need a function that, given some LED intensity settings and our lookup table, can predict the spectral output.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">pinfo2</span> stlab.predict_spd
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-intense-fg ansi-bold">Signature:</span>
stlab<span class="ansi-yellow-intense-fg ansi-bold">.</span>Device<span class="ansi-yellow-intense-fg ansi-bold">.</span>predicted_spd<span class="ansi-yellow-intense-fg ansi-bold">(</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>    self<span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>    intensity<span class="ansi-yellow-intense-fg ansi-bold">=</span><span class="ansi-yellow-intense-fg ansi-bold">[</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> <span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">]</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>    lkp_table<span class="ansi-yellow-intense-fg ansi-bold">=</span><span class="ansi-green-intense-fg ansi-bold">None</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-yellow-intense-fg ansi-bold">
</span><span class="ansi-yellow-intense-fg ansi-bold">)</span>
<span class="ansi-red-intense-fg ansi-bold">Source:</span>
    <span class="ansi-green-intense-fg ansi-bold">def</span> predicted_spd<span class="ansi-yellow-intense-fg ansi-bold">(</span>self<span class="ansi-yellow-intense-fg ansi-bold">,</span> intensity<span class="ansi-yellow-intense-fg ansi-bold">=</span><span class="ansi-yellow-intense-fg ansi-bold">[</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">,</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">]</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> lkp_table<span class="ansi-yellow-intense-fg ansi-bold">=</span><span class="ansi-green-intense-fg ansi-bold">None</span><span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">:</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>        <span class="ansi-blue-intense-fg ansi-bold">&#34;&#34;&#34;
        Predict the spectral power distribution for a given list of led
        intensities using linear interpolation.

        Parameters
        ----------
        intensity : list
            List of intensity values for each led. The default is [0,0,0,0,0,0,0,0,0,0].
        lkp_table : DataFrame
            A wide-format DataFrame with hierarchichal pd.MultIndex [led, intensity]
            and a column for each of 81 5-nm wavelength bins. 4096*10 rows, containing
            predicted for each led at all possible intensities.

        Returns
        -------
        spectrum : np.array
            Predicted spectrum for given intensities.
        &#34;&#34;&#34;</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>        spectrum <span class="ansi-yellow-intense-fg ansi-bold">=</span> np<span class="ansi-yellow-intense-fg ansi-bold">.</span>zeros<span class="ansi-yellow-intense-fg ansi-bold">(</span><span class="ansi-cyan-intense-fg ansi-bold">81</span><span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>        <span class="ansi-green-intense-fg ansi-bold">for</span> led <span class="ansi-yellow-intense-fg ansi-bold">,</span> val <span class="ansi-green-intense-fg ansi-bold">in</span> enumerate<span class="ansi-yellow-intense-fg ansi-bold">(</span>intensity<span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">:</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>            spectrum <span class="ansi-yellow-intense-fg ansi-bold">+=</span> lkp_table<span class="ansi-yellow-intense-fg ansi-bold">.</span>loc<span class="ansi-yellow-intense-fg ansi-bold">[</span><span class="ansi-yellow-intense-fg ansi-bold">(</span>led<span class="ansi-yellow-intense-fg ansi-bold">,</span>val<span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">]</span><span class="ansi-yellow-intense-fg ansi-bold">.</span>to_numpy<span class="ansi-yellow-intense-fg ansi-bold">(</span><span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">
</span>        <span class="ansi-green-intense-fg ansi-bold">return</span> spectrum
<span class="ansi-red-intense-fg ansi-bold">File:</span>      c:\users\engs2242\documents\cvd_pupillometry\code\python\pyplr\stlab_apy.py
<span class="ansi-red-intense-fg ansi-bold">Type:</span>      function

</pre></div></div>
</div>
<p>If the STLAB is still connected, let’s use our lookup table and <code class="docutils literal notranslate"><span class="pre">stlab.predicted_spd(...)</span></code> to predict the output for some random inputs and then compare this with a readout from the spectrometer.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># set up fgiure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">axs</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

<span class="c1"># predict, measure and plot for 8 random inputs</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">random_input</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span> <span class="k">for</span> <span class="n">led</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="n">predicted_spectrum</span> <span class="o">=</span> <span class="n">stlab</span><span class="o">.</span><span class="n">predict_spd</span><span class="p">(</span><span class="n">random_input</span><span class="p">,</span> <span class="n">lkp_table</span><span class="o">=</span><span class="n">lkp_tbl</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">set_spectrum_a</span><span class="p">(</span><span class="n">random_input</span><span class="p">)</span>
    <span class="n">measured_spectrum</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get_spectrometer_spectrum</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">turn_off</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wlbins</span><span class="p">,</span> <span class="n">predicted_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wlbins</span><span class="p">,</span> <span class="n">measured_spectrum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5000</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux (mW)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">:]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelenght (nm)&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x269b8d5ec48&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/stlab_and_sphere_22_1.png" src="_images/stlab_and_sphere_22_1.png" />
</div>
</div>
<p>Looks like the predictions are fairly accurate, but eventually it would be good to recreate this model with measurements taken from an external spectrometer looking into the integrating sphere.</p>
</div>
<div class="section" id="Device-stability">
<h2><strong>Device stability</strong><a class="headerlink" href="#Device-stability" title="Permalink to this headline">¶</a></h2>
<p>The manual for the STLAB claims perfect stability over time thanks to an on-board CMOS spectrophotometer and associated feedback loop control algorithms. But we can test this for ourselves:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">leds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="n">intensity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4095</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> minutes left...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">180</span><span class="o">-</span><span class="n">t</span><span class="p">))</span>
    <span class="n">spectra</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">sample_leds</span><span class="p">(</span><span class="n">leds</span><span class="o">=</span><span class="n">leds</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="n">intensity</span><span class="p">,</span> <span class="n">wait_before_sample</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">spectra</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;STLAB_stability.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code samples each LED every (roughly) five minutes across 3 hours (36 measurements in total) and saves the results in a DataFrame. But to save time, let’s just load some data generated by a previous run of this code.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># load existing data</span>
<span class="n">stability</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../../../data/stlab/STLAB_3h_stability.csv&quot;</span><span class="p">)</span>

<span class="c1"># set up figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># plot SPDs</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stability</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;led&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">estimator</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux (mW)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Wavelength (nm)&quot;</span><span class="p">)</span>

<span class="c1"># get max for led-cycle</span>
<span class="n">maxs</span> <span class="o">=</span> <span class="n">stability</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;led&quot;</span><span class="p">,</span><span class="s2">&quot;time&quot;</span><span class="p">])[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">axs</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

<span class="k">for</span> <span class="n">led</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
    <span class="n">mis</span> <span class="o">=</span> <span class="n">stlab</span><span class="o">.</span><span class="n">spectra_to_melanopic_irradiance</span><span class="p">(</span><span class="n">stability</span><span class="p">,</span> <span class="n">grouper</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">mis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">led</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">led</span><span class="p">])</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">mis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">led</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">mis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">led</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">mis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">led</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">mis</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">led</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
    <span class="c1">#maxs.loc[led].plot(ax=ax, c=colors[led])</span>
    <span class="c1">#low, high = maxs.loc[led].min() - maxs.loc[led].min() * 0.1, maxs.loc[led].max() + maxs.loc[led].max() * 0.1</span>
    <span class="c1">#ax.set_ylim((low, high))</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Melanopic irradiance (mW)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (min)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/stlab_and_sphere_25_0.png" src="_images/stlab_and_sphere_25_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/stlab_and_sphere_25_1.png" src="_images/stlab_and_sphere_25_1.png" />
</div>
</div>
</div>
<div class="section" id="Timing-in-synchronous-mode">
<h2><strong>Timing in synchronous mode</strong><a class="headerlink" href="#Timing-in-synchronous-mode" title="Permalink to this headline">¶</a></h2>
<p>The STLAB operates in <strong>synchronous</strong> mode by default, meaning that all commands sent by the LIGHT HUB must be acknowledged before a new instruction can be processed. The manual claims that response times in this mode of operation are on the order of around 250 milliseconds. We can test this.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="n">spec</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4095</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span>
<span class="n">off</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span>
<span class="n">exec_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">set_spectrum_a</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">set_spectrum_a</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
    <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">exec_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">exec_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t4</span><span class="o">-</span><span class="n">t3</span><span class="p">)</span>

<span class="n">exec_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">exec_times</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">exec_times</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">exec_times</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Execution time (s)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
count    400.000000
mean       0.119784
std        0.007681
min        0.102159
25%        0.116358
50%        0.119533
75%        0.122504
max        0.150041
dtype: float64
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/stlab_and_sphere_27_1.png" src="_images/stlab_and_sphere_27_1.png" />
</div>
</div>
<p>It probably depends on the machine, hardware, other processes, etc., but often we see worse timings, with commands sometimes taking up to 5 s to execute. Given that we may want to calculate (e.g.) accurate measures of pupil response times, the uncertainty here is problematic. Thankfully the STLAB also has an <strong>asynchronous</strong> mode of operation which allows for real-time spectral streaming with a spectral switching time of less than 10 milliseconds (i.e. 1 spectrum every 10 milliseconds). We will
need to leverage this mode in order to get the desired control over the temporal properties of our light stimuli.</p>
</div>
<div class="section" id="Making-video-files-to-play-in-asynchronous-mode">
<h2><strong>Making video files to play in asynchronous mode</strong><a class="headerlink" href="#Making-video-files-to-play-in-asynchronous-mode" title="Permalink to this headline">¶</a></h2>
<p>For asynchronous mode we need to create video files, which are basically json files with a .dsf (dynamic sequence file) extension. Let’s create a video file that sequentially ramps up each LED by 5 intensity steps every 10 ms.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">specs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">led</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">intensity</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span>
        <span class="n">spec</span><span class="p">[</span><span class="n">led</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">10</span>
<span class="n">specs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;primary-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="n">cols</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">specs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span>
<span class="n">specs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>primary-0</th>
      <th>primary-1</th>
      <th>primary-2</th>
      <th>primary-3</th>
      <th>primary-4</th>
      <th>primary-5</th>
      <th>primary-6</th>
      <th>primary-7</th>
      <th>primary-8</th>
      <th>primary-9</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>20</td>
      <td>10</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30</td>
      <td>15</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>40</td>
      <td>20</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8195</th>
      <td>81950</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4075</td>
    </tr>
    <tr>
      <th>8196</th>
      <td>81960</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4080</td>
    </tr>
    <tr>
      <th>8197</th>
      <td>81970</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4085</td>
    </tr>
    <tr>
      <th>8198</th>
      <td>81980</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4090</td>
    </tr>
    <tr>
      <th>8199</th>
      <td>81990</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>4095</td>
    </tr>
  </tbody>
</table>
<p>8200 rows × 11 columns</p>
</div></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">stlab.make_video_file(...)</span></code> to turn any DataFrame with the above format into a video file playable by the STLAB. The following requirements must currently be met:</p>
<ol class="arabic simple">
<li><p>The DataFrame has columns (in this order): time, primary-0, primary-1, primary-2, primary-3, primary-4, primary-5, primary-6, primary-7, primary-8, primary-9</p></li>
<li><p>The intensity settings range between 0 - 4095</p></li>
<li><p>Consecutive values of time differ by at least 10 ms (the file will still play, but spectra will be skipped)</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">stlab</span><span class="o">.</span><span class="n">make_video_file</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="s2">&quot;our_video_file&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Now we can load and play the video file using <code class="docutils literal notranslate"><span class="pre">Device.load_video_file(...)</span></code> and <code class="docutils literal notranslate"><span class="pre">Device.play_video_file(...)</span></code>. If we want to stop playback of the video file prematurely, we can say <code class="docutils literal notranslate"><span class="pre">Device.play_video_file(stop=True)</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># load the video file</span>
<span class="n">d</span><span class="o">.</span><span class="n">load_video_file</span><span class="p">(</span><span class="n">video</span><span class="o">=</span><span class="s2">&quot;our_video_file.dsf&quot;</span><span class="p">)</span>

<span class="c1"># start playing the video file</span>
<span class="n">d</span><span class="o">.</span><span class="n">play_video_file</span><span class="p">()</span>

<span class="c1"># wait for 20 s and stop playback</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">20.</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">play_video_file</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># turn off the light</span>
<span class="n">d</span><span class="o">.</span><span class="n">turn_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PyPlr</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="overview.html">Overview</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="overview.html#hardware-interfacing">Hardware interfacing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Example Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">To Do…</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="overview.html">Overview</a><ul>
      <li>Previous: <a href="pupil_core.html" title="previous chapter">Measuring the pupillary light reflex with a Pupil Core headset</a></li>
      <li>Next: <a href="ocean_optics_calibration.html" title="next chapter">Calibration with OceanOptics VIS spectrometer</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Joel T. Martin and Manuel Spitschan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/stlab_and_sphere.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>